(function(){var b=YAHOO.util.Dom,F=YAHOO.util.Event,s=YAHOO.util.KeyListener,y=YAHOO.util.Selector;var v=Alfresco.util.encodeHTML,r=Alfresco.util.combinePaths,C=Alfresco.util.hasEventInterest;Alfresco.module.DoclibGlobalFolder=function(G){Alfresco.module.DoclibGlobalFolder.superclass.constructor.call(this,"Alfresco.module.DoclibGlobalFolder",G,["button","container","connection","json","treeview"]);this.containers={};if(G!="null"){this.eventGroup=G;try{YAHOO.Bubbling.unsubscribe("siteChanged",null,this);YAHOO.Bubbling.unsubscribe("containerChanged",null,this)}catch(H){}YAHOO.Bubbling.on("siteChanged",this.onSiteChanged,this);YAHOO.Bubbling.on("containerChanged",this.onContainerChanged,this)}return this};var A=Alfresco.module.DoclibGlobalFolder;YAHOO.lang.augmentObject(A,{VIEW_MODE_SITE:0,VIEW_MODE_REPOSITORY:1,VIEW_MODE_USERHOME:2,VIEW_MODE_RECENT_SITES:3,VIEW_MODE_FAVOURITE_SITES:4,VIEW_MODE_SHARED:5});YAHOO.extend(Alfresco.module.DoclibGlobalFolder,Alfresco.component.Base,{options:{siteId:"",siteTitle:"",containerId:"documentLibrary",containerType:"cm:folder",rootNode:"alfresco://company/home",sharedRoot:"alfresco://company/shared",userHome:"alfresco://user/home",path:"",pathNodeRef:null,width:"60em",files:null,templateUrl:Alfresco.constants.URL_SERVICECONTEXT+"modules/documentlibrary/global-folder",viewMode:A.VIEW_MODE_RECENT_SITES,defaultView:A.VIEW_MODE_RECENT_SITES,allowedViewModes:[A.VIEW_MODE_SITE,A.VIEW_MODE_RECENT_SITES,A.VIEW_MODE_FAVOURITE_SITES,A.VIEW_MODE_SHARED,A.VIEW_MODE_REPOSITORY,A.VIEW_MODE_USERHOME],evaluateChildFoldersSite:true,maximumFolderCountSite:-1,webscriptTimeout:7000,evaluateChildFoldersRepo:true,maximumFolderCountRepo:-1,siteTreeContainerTypes:{},sitesAPI:Alfresco.constants.PROXY_URI+"api/people/"+encodeURIComponent(Alfresco.constants.USERNAME)+"/sites",recentSitesAPI:Alfresco.constants.PROXY_URI+"api/people/"+encodeURIComponent(Alfresco.constants.USERNAME)+"/sites/recent",favouriteSitesAPI:Alfresco.constants.PROXY_URI+"api/people/"+encodeURIComponent(Alfresco.constants.USERNAME)+"/sites/favourites",containersAPI:Alfresco.constants.PROXY_URI+"slingshot/doclib/containers/",templateFailMessage:"Could not load 'global-folder' template",customFolderStyleConfig:null},containerDiv:null,pathsToExpand:null,selectedNode:null,containers:null,showDialog:function m(){if(!this.containerDiv){Alfresco.util.Ajax.request({url:this.options.templateUrl,dataObj:{htmlid:this.id},successCallback:{fn:this.onTemplateLoaded,scope:this},failureMessage:this.options.templateFailMessage,execScripts:true})}else{this._beforeShowDialog()}},onTemplateLoaded:function o(H){var L=this;this.containerDiv=document.createElement("div");this.containerDiv.setAttribute("style","display:none");this.containerDiv.innerHTML=H.serverResponse.responseText;var J=b.getFirstChild(this.containerDiv);this.widgets.dialog=Alfresco.util.createYUIPanel(J,{width:this.options.width});this.widgets.linkButton=Alfresco.util.createYUIButton(this,"link",this.onCreateLink,{additionalClass:"alf-primary-button"});if(this.widgets.linkButton){this.widgets.linkButton.set("label",this.msg("link.button"));this.widgets.linkButton.set("style","display:none")}this.widgets.okButton=Alfresco.util.createYUIButton(this,"ok",this.onOK,{additionalClass:"alf-primary-button"});this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel",this.onCancel);var N=new YAHOO.widget.ButtonGroup(this.id+"-modeGroup");N.on("checkedButtonChange",this.onViewModeChange,this.widgets.modeButtons,this);this.widgets.modeButtons=N;var K=this.widgets.modeButtons.getButtons(),M=function(O){if(s.KEY.ENTER==O.keyCode){this.set("checked",true)}};for(var I=0;I<K.length;I++){K[I].addListener("keydown",M)}this.fnLoadNodeData=function G(S,P){var Q=S.data.path;var R=L._buildTreeNodeUrl.call(L,Q);var U={success:function O(Y){var X=Alfresco.util.parseJSON(Y.responseText);if(X.parent){if(S.data.nodeRef.indexOf("alfresco://")===0){S.data.nodeRef=X.parent.nodeRef}if(typeof S.data.userAccess=="undefined"){S.data.userAccess=X.parent.userAccess;S.setUpLabel({label:S.label,style:X.parent.userAccess.create?"":"no-permission"});if(X.parent.userAccess.create==false){S.parent.refresh();if(this.selectedNode==S){this.widgets.okButton.set("disabled",true);if(this.widgets.linkButton){this.widgets.linkButton.set("disabled",true)}}}}}if(X.items){var Z,ab;for(var W=0,V=X.items.length;W<V;W++){Z=X.items[W];var aa=this.options.mode=="sync"&&Alfresco.util.arrayContains(Z.aspects,"sync:syncSetMemberNode");ab=new YAHOO.widget.TextNode({label:Z.name,path:r(Q,Z.name),nodeRef:Z.nodeRef,description:Z.description,userAccess:aa?false:Z.userAccess,style:aa?"no-permission":(Z.userAccess.create?"":"no-permission")},S,false);var ac=this._buildCustomStyleClass(Z);ab.customCls=ac;if(!Z.hasChildren){ab.isLeaf=true}}if(X.resultsTrimmed){ab=new YAHOO.widget.TextNode({label:"<"+this.msg("message.folders-trimmed",X.items.length)+">",hasIcon:false,style:"folders-trimmed"},S,false)}}Y.argument.fnLoadComplete()},failure:function T(Y){try{var X=YAHOO.lang.JSON.parse(Y.responseText);var W=this.widgets.treeview.getRoot();var V=W.children[0];V.isLoading=false;V.isLeaf=true;V.label=X.message;V.labelStyle="ygtverror";W.refresh()}catch(Z){}},scope:L,argument:{node:S,fnLoadComplete:P},timeout:L.options.webscriptTimeout};if(YAHOO.env.ua.ie>0){R+=(R.indexOf("?")==-1?"?":"&")+"noCache="+new Date().getTime()}YAHOO.util.Connect.asyncRequest("GET",R,U)};this._beforeShowDialog()},_beforeShowDialog:function u(){if(this.options.pathNodeRef){var G=Alfresco.constants.PROXY_URI+"slingshot/doclib/node/"+this.options.pathNodeRef.uri+"/location";if(this.options.rootNode){G+="?libraryRoot="+encodeURIComponent(this.options.rootNode.toString())}Alfresco.util.Ajax.jsonGet({url:G,successCallback:{fn:function(I){if(I.json!==undefined){var H=I.json;if(H.site){this.options.viewMode=A.prototype.options.defaultView;this.options.path=r(H.site.path,H.site.file);this.options.siteId=H.site.site;this.options.siteTitle=H.site.siteTitle}else{this.options.viewMode=A.VIEW_MODE_REPOSITORY;this.options.path=r(H.repo.path,H.repo.file);this.options.siteId=null;this.options.siteTitle=null}this._showDialog()}},scope:this},failureMessage:this.msg("message.failure")})}else{this._showDialog()}},_showDialog:function q(){this.widgets.okButton.set("disabled",false);this.widgets.cancelButton.set("disabled",false);if(this.widgets.linkButton){this.widgets.linkButton.set("disabled",false)}var G=b.get(this.id+"-title");if(this.options.title){G.innerHTML=this.options.title}else{if(YAHOO.lang.isArray(this.options.files)){G.innerHTML=this.msg("title.multi",this.options.files.length)}else{G.innerHTML=this.msg("title.single",'<span class="light">'+v(this.options.files.displayName)+"</span>")}}var O=Alfresco.util.arrayToObject(this.options.allowedViewModes);for(var J=0;J<Alfresco.constants.HIDDEN_PICKER_VIEW_MODES.length;J++){delete O[A[Alfresco.constants.HIDDEN_PICKER_VIEW_MODES[J]]]}var L=this.widgets.modeButtons.getButtons(),H,I;if(!(this.options.viewMode in O)){this.options.viewMode=parseInt(Object.keys(O)[0])}for(var J=0,P=L.length;J<P;J++){H=L[J];I=parseInt(H.get("name"),10);H.set("disabled",!(I in O));H.setStyle("display",I in O?"block":"none");if(I==this.options.viewMode){if(H.get("checked")){this.setViewMode(I)}else{H.set("checked",true)}}}if(!this.widgets.escapeListener){this.widgets.escapeListener=new s(document,{keys:s.KEY.ESCAPE},{fn:function(R,Q){this.onCancel()},scope:this,correctScope:true})}this.widgets.dialog.render(this.options.parentElement||document.body);if(this.options.zIndex!==undefined&&this.options.zIndex>0){var M=this.options.zIndex+2;var N=this.widgets.dialog;var K=function(){elements=b.getElementsByClassName("mask");for(J=0,j=elements.length;J<j;J++){b.setStyle(elements[J],"zIndex",M-1)}b.setStyle(N.element,"zIndex",M);N.cfg.setProperty("zIndex",M,true)};this.widgets.dialog.beforeShowEvent.subscribe(K,this.widgets.dialog,true)}this.widgets.escapeListener.enable();this.widgets.dialog.show()},setViewMode:function k(G){this.options.viewMode=G;if(this._isSiteViewMode(G)){b.get(this.id+"-treeview").innerHTML="";b.removeClass(this.id+"-wrapper","repository-mode");this._populateSitePicker(G)}else{b.addClass(this.id+"-wrapper","repository-mode");var H=this.options.rootNode;if(G==A.VIEW_MODE_USERHOME){H=this.options.userHome}else{if(G==A.VIEW_MODE_SHARED){H=this.options.sharedRoot}}this._buildTree(H);this.onPathChanged(this.options.path?this.options.path:"/")}},onSiteChanged:function B(L,J){if(C(this,J)){var N=J[1];if(N!==null){if(N.site!==null){this.options.siteId=N.site;this.options.siteTitle=N.siteTitle;this._populateContainerPicker();var M=y.query("a",this.id+"-sitePicker"),I,K,H,G=b.get(this.id+"-sitePicker");for(K=0,H=M.length;K<H;K++){I=M[K];if(I.getAttribute("rel")==N.site){b.addClass(I,"selected");if(N.scrollTo){G.scrollTop=b.getY(I)-b.getY(G)}}else{b.removeClass(I,"selected")}}}}}},onContainerChanged:function f(L,J){if(C(this,J)){var N=J[1];if(N!==null){if(N.container!==null){this.options.containerId=N.container;this.options.containerType=this.containers[N.container].type;this._buildTree(this.containers[N.container].nodeRef);this.onPathChanged(this.options.path);var M=y.query("a",this.id+"-containerPicker"),G,K,I,H=b.get(this.id+"-containerPicker");for(K=0,I=M.length;K<I;K++){G=M[K];if(G.getAttribute("rel")==N.container){b.addClass(G,"selected");if(N.scrollTo){H.scrollTop=b.getY(G)-b.getY(H)}}else{b.removeClass(G,"selected")}}}}}},onOK:function l(H,I){this.widgets.escapeListener.disable();this.widgets.dialog.hide();var G=this.selectedNode?this.selectedNode.data:null;if(G&&this._isSiteViewMode(this.options.viewMode)){G.siteId=this.options.siteId;G.siteTitle=this.options.siteTitle;G.containerId=this.options.containerId}YAHOO.Bubbling.fire("folderSelected",{selectedFolder:G,eventGroup:this})},onCreateLink:function t(H,I){this.widgets.escapeListener.disable();this.widgets.dialog.hide();var G=this.selectedNode?this.selectedNode.data:null;if(G&&this._isSiteViewMode(this.options.viewMode)){G.siteId=this.options.siteId;G.siteTitle=this.options.siteTitle;G.containerId=this.options.containerId}YAHOO.Bubbling.fire("folderSelected",{selectedFolder:G,eventGroup:this})},onCancel:function a(G,H){this.widgets.escapeListener.disable();this.widgets.dialog.hide()},onViewModeChange:function n(I,J){var H=this.options.viewMode;try{H=parseInt(I.newValue.get("name"),10);this.setViewMode(H)}catch(G){}},onExpandComplete:function h(J){Alfresco.logger.debug("DLGF_onExpandComplete");this.widgets.treeview.render();this._showHighlight(true);if(this.pathsToExpand&&this.pathsToExpand.length>0){var I=this.widgets.treeview.getNodeByProperty("path",this.pathsToExpand.shift());if(I!==null){var H=I.getContentEl(),G=b.get(this.id+"-treeview");G.scrollTop=b.getY(H)-(G.scrollHeight/3);if(I.data.path==this.currentPath){this._updateSelectedNode(I)}I.expand()}}},onNodeClicked:function x(H){Alfresco.logger.debug("DLGF_onNodeClicked");var J=H.event,I=H.node,G=I.data.userAccess;if((G&&G.create)||(I.data.nodeRef=="")||(I.data.nodeRef.indexOf("alfresco://")===0)){this.onPathChanged(I.data.path);this._updateSelectedNode(I)}F.preventDefault(J);return false},onPathChanged:function d(K){this._showHighlight(false);this.selectedNode=null;Alfresco.logger.debug("DLGF_onPathChanged:"+K);if(K.charAt(0)!="/"){K="/"+K}this.currentPath=K;var J=this.widgets.treeview.getNodeByProperty("path",K);if(J!==null){this._updateSelectedNode(J);J.expand();while(J.parent!==null){J=J.parent;J.expand()}return}var L=K.split("/"),I="/";if(K==="/"){L=[""]}this.pathsToExpand=[];for(var H=0,G=L.length;H<G;H++){I=r("/",I,L[H]);this.pathsToExpand.push(I)}Alfresco.logger.debug("DLGF_onPathChanged paths to expand:"+this.pathsToExpand.join(","));do{J=this.widgets.treeview.getNodeByProperty("path",this.pathsToExpand.shift());if(this.selectedNode==null){this._updateSelectedNode(J)}}while(this.pathsToExpand.length>0&&J.expanded);if(J!==null){J.expand()}},_populateSitePicker:function z(J){var H=b.get(this.id+"-sitePicker"),L=this;H.innerHTML="";var K=function G(P,T){var U=P.json,R,N,S,Q,W=null;var V=function O(X){return function(){YAHOO.Bubbling.fire("siteChanged",{site:X.shortName,siteTitle:X.title,eventGroup:L});return false}};if(U.length>0){W=U[0]}for(S=0,Q=U.length;S<Q;S++){N=U[S];if(Alfresco.util.arrayToObject(N.shortName)){if(W==null){W=N}R=document.createElement("div");if(S==Q-1){b.addClass(R,"last")}R.innerHTML='<a rel="'+N.shortName+'" href="#""><h4>'+v(N.title)+"</h4><span>"+v(N.description)+"</span></a>";R.onclick=V(N);T.appendChild(R)}}if(W!=null){YAHOO.Bubbling.fire("siteChanged",{site:(this.options.siteId&&this.options.siteId.length>0)?this.options.siteId:W.shortName,siteTitle:(this.options.siteId&&this.options.siteId.length>0)?this.options.siteTitle:W.title,eventGroup:this,scrollTo:true})}};var M=this.options.sitesAPI;if(J===A.VIEW_MODE_RECENT_SITES){M=this.options.recentSitesAPI}else{if(J===A.VIEW_MODE_FAVOURITE_SITES){M=this.options.favouriteSitesAPI}}var I={url:M,responseContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:K,scope:this,obj:H},failureCallback:null};Alfresco.util.Ajax.request(I)},_populateContainerPicker:function e(){var N=b.get(this.id+"-containerPicker"),K=this;N.innerHTML="";var J=function G(Q,V){var P=Q.json.containers,S,O,T,R;this.containers={};var W=function U(X){return function(){YAHOO.Bubbling.fire("containerChanged",{container:X,eventGroup:K});return false}};for(T=0,R=P.length;T<R;T++){O=P[T];this.containers[O.name]=O;S=document.createElement("div");if(T==R-1){b.addClass(S,"last")}S.innerHTML='<a rel="'+O.name+'" href="#"><h4>'+O.name+"</h4><span>"+O.description+"</span></a>";S.onclick=W(O.name);V.appendChild(S)}YAHOO.Bubbling.fire("containerChanged",{container:this.options.containerId,eventGroup:this,scrollTo:true})};var M=function L(Q){try{var P=this.widgets.treeview.getRoot(),O=P.children[0];O.isLoading=false;O.isLeaf=true;O.label=this.msg("message.error");O.labelStyle="ygtverror";P.refresh()}catch(R){}N.innerHTML=""};var I=Alfresco.util.parseURL(this.options.containersAPI);I.pathname+=this.options.siteId;var H={url:I.getUrl(),responseContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:J,scope:this,obj:N},failureCallback:{fn:M,scope:this}};Alfresco.util.Ajax.request(H)},_buildTree:function g(J){Alfresco.logger.debug("DLGF__buildTree");var G=new YAHOO.widget.TreeView(this.id+"-treeview");this.widgets.treeview=G;YAHOO.widget.TreeView.FOCUS_CLASS_NAME="";G.setDynamicLoad(this.fnLoadNodeData);var H="location.path.repository";if(this._isSiteViewMode(this.options.viewMode)){var I=this.options.siteTreeContainerTypes[this.options.containerType]||{};H=I.rootLabel||"location.path.documents"}else{if(this.options.viewMode==A.VIEW_MODE_USERHOME){H="location.path.myfiles"}else{if(this.options.viewMode==A.VIEW_MODE_SHARED){H="location.path.shared"}}}var K=new YAHOO.widget.TextNode({label:this.msg(H),path:"/",nodeRef:J},G.getRoot(),false);G.subscribe("clickEvent",this.onNodeClicked,this,true);G.subscribe("expandComplete",this.onExpandComplete,this,true);G.render()},_showHighlight:function p(G){Alfresco.logger.debug("DLGF__showHighlight");if(this.selectedNode!==null){if(G){b.addClass(this.selectedNode.getEl(),"selected")}else{b.removeClass(this.selectedNode.getEl(),"selected")}}},_updateSelectedNode:function w(G){Alfresco.logger.debug("DLGF__updateSelectedNode");this._showHighlight(false);this.selectedNode=G;this._showHighlight(true);if(G.data.userAccess&&!G.data.userAccess.create){this.widgets.okButton.set("disabled",true);if(this.widgets.linkButton){this.widgets.linkButton.set("disabled",true)}}else{this.widgets.okButton.set("disabled",false);if(this.widgets.linkButton){this.widgets.linkButton.set("disabled",false)}}},_buildTreeNodeUrl:function c(I){var J=Alfresco.constants.PROXY_URI;if(this._isSiteViewMode(this.options.viewMode)){var G=this.options.siteTreeContainerTypes[this.options.containerType]||{};if(G.uri){J+=G.uri}else{J+="slingshot/doclib/treenode/site/{site}/{container}{path}";J+="?children={evaluateChildFoldersSite}";J+="&max={maximumFolderCountSite}"}}else{if(this.options.viewMode==A.VIEW_MODE_USERHOME){J+="slingshot/doclib/treenode/node/{userHome}{path}";J+="?children={evaluateChildFoldersRepo}"}else{if(this.options.viewMode==A.VIEW_MODE_SHARED){J+="slingshot/doclib/treenode/node/{sharedRootPath}{path}";J+="?children={evaluateChildFoldersRepo}";J+="&libraryRoot={sharedRoot}"}else{J+="slingshot/doclib/treenode/node/alfresco/company/home{path}";J+="?children={evaluateChildFoldersRepo}";J+="&libraryRoot={repositoryRoot}"}}J+="&max={maximumFolderCountRepo}"}var H=YAHOO.lang.substitute(J,{site:encodeURIComponent(this.options.siteId),container:encodeURIComponent(this.options.containerId),rootNode:this.options.rootNode,repositoryRoot:this.options.repositoryRoot?this.options.repositoryRoot:this.options.rootNode,userHome:(this.options.userHome||"").replace(":/",""),sharedRoot:this.options.sharedRoot,sharedRootPath:this.options.sharedRoot.replace(":/",""),path:Alfresco.util.encodeURIPath(I),evaluateChildFoldersSite:this.options.evaluateChildFoldersSite+"",maximumFolderCountSite:this.options.maximumFolderCountSite,evaluateChildFoldersRepo:this.options.evaluateChildFoldersRepo+"",maximumFolderCountRepo:this.options.maximumFolderCountRepo});return H},_buildCustomStyleClass:function i(G){var I=null;if(this.options.customFolderStyleConfig){var H=new Alfresco.CommonComponentStyleFilterChain(G,this.options.customFolderStyleConfig.browse.folder);I=H.createCustomStyle()}return I},_isSiteViewMode:function E(H){var G=[A.VIEW_MODE_SITE,A.VIEW_MODE_FAVOURITE_SITES,A.VIEW_MODE_RECENT_SITES];return(Alfresco.util.arrayContains(G,H))}});var D=new Alfresco.module.DoclibGlobalFolder("null")})();