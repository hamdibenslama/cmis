(function(){var B=YAHOO.util.Dom,f=YAHOO.util.Element,v=YAHOO.util.KeyListener,A=YAHOO.util.Event;var y=Alfresco.util.encodeHTML;Alfresco.DNDUpload=function(M){Alfresco.DNDUpload.superclass.constructor.call(this,"Alfresco.DNDUpload",M,["button","container","datatable","datasource"]);this.fileStore={};this.addedFiles={};this.defaultShowConfig={files:[],siteId:null,containerId:null,destination:null,uploadDirectory:null,updateNodeRef:null,updateFilename:null,updateVersion:"1.0",mode:this.MODE_SINGLE_UPLOAD,filter:[],onFileUploadComplete:null,overwrite:false,thumbnails:null,uploadURL:null,username:null,suppressRefreshEvent:false,maximumFileSize:0};this.suppliedConfig={};this.showConfig={};this.fileItemTemplates={};if(typeof FormData!=="undefined"){this.uploadMethod=this.FORMDATA_UPLOAD}else{this.uploadMethod=this.INMEMORY_UPLOAD}return this};YAHOO.extend(Alfresco.DNDUpload,Alfresco.component.Base,{contentReady:false,FORMDATA_UPLOAD:1,INMEMORY_UPLOAD:2,uploadMethod:2,STATE_BROWSING:1,STATE_ADDED:2,STATE_UPLOADING:3,STATE_FINISHED:4,STATE_FAILURE:5,STATE_SUCCESS:6,state:1,fileStore:null,noOfSuccessfulUploads:0,noOfFailedUploads:0,aggregateUploadTargetSize:0,aggregateUploadCurrentSize:0,addedFiles:null,MODE_SINGLE_UPLOAD:1,MODE_SINGLE_UPDATE:2,MODE_MULTI_UPLOAD:3,defaultShowConfig:null,suppliedConfig:null,showConfig:null,panel:null,dataTable:null,titleText:null,statusText:null,aggregateProgressText:null,aggregateDataWrapper:null,fileSelectionInput:null,minorVersion:null,description:null,versionSection:null,fileItemTemplates:null,_maximumFileSizeLimit:0,setMaximumFileSizeLimit:function G(M){this._maximumFileSizeLimit=M},getMaximumFileSizeLimit:function g(){return this._maximumFileSizeLimit},_inMemoryLimit:250000000,setInMemoryLimit:function C(M){if(isNaN(M)){Alfresco.logger.warn('Non-numerical value set for "in-memory-limit" in share-documentlibrary.xml: ',M);this._inMemoryLimit=25000000}else{this._inMemoryLimit=M}},getInMemoryLimit:function g(){return this._inMemoryLimit},onReady:function i(){B.removeClass(this.id+"-dialog","hidden");this.panel=Alfresco.util.createYUIPanel(this.id+"-dialog");this.panel.hideEvent.subscribe(this.onCancelOkButtonClick,null,this);this.fileItemTemplates.left=B.get(this.id+"-left-div");this.fileItemTemplates.center=B.get(this.id+"-center-div");this.fileItemTemplates.right=B.get(this.id+"-right-div");this._createEmptyDataTable();this.titleText=B.get(this.id+"-title-span");this.statusText=B.get(this.id+"-status-span");this.aggregateProgressText=B.get(this.id+"-aggregate-status-span");this.aggregateDataWrapper=B.get(this.id+"-aggregate-data-wrapper");this.description=B.get(this.id+"-description-textarea");this.minorVersion=B.get(this.id+"-minorVersion-radioButton");this.versionSection=B.get(this.id+"-versionSection-div");this.compareVersionsSection=B.get(this.id+"-compare-versions");this.widgets.cancelOkButton=Alfresco.util.createYUIButton(this,"cancelOk-button",this.onCancelOkButtonClick);this.widgets.uploadButton=Alfresco.util.createYUIButton(this,"upload-button",this.onUploadButtonClick,{additionalClass:"alf-primary-button"});this.widgets.fileSelectionOverlayButton=Alfresco.util.createYUIButton(this,"file-selection-button-overlay",this._doNothing,{additionalClass:"alf-primary-button"});B.addClass(this.widgets.fileSelectionOverlayButton._button,"dnd-file-selection-button-overlay");B.addClass(this.widgets.fileSelectionOverlayButton._button.parentNode,"dnd-file-selection-button-overlay-wrapper");this.widgets.escapeListener=new v(document,{keys:v.KEY.ESCAPE},{fn:this.onCancelOkButtonClick,scope:this,correctScope:true})},_doNothing:function K(){},onFileSelection:function J(M){var Q=M.target.files;if(Q!=null){this.showConfig.files=Q;if(this.dataTable!=null){this.dataTable.set("height","204px",true)}var O=true;for(var P=0;P<Q.length;P++){if(Q[P].size!==0){O=false;break}}if(O){this.processFilesForUpload(this.showConfig.files)}else{if(this.suppliedConfig.mode==this.MODE_SINGLE_UPDATE){this.widgets.uploadButton.set("disabled",false);B.removeClass(this.widgets.uploadButton,"hidden");var N=M.target.files[0];if(this.showConfig.newVersion&&this._isNewFileName(this.showConfig.jsNode,N)){B.removeClass(this.compareVersionsSection,"hidden");this._updateCompareVersionsSection(this.showConfig.jsNode,N)}else{B.addClass(this.compareVersionsSection,"hidden")}}else{B.removeClass(this.id+"-filelist-table","hidden");B.removeClass(this.id+"-aggregate-data-wrapper","hidden");B.addClass(this.id+"-file-selection-controls","hidden");this.processFilesForUpload(this.showConfig.files)}}}else{}},show:function n(N){var O=this;this.suppliedConfig=N;this.showConfig=YAHOO.lang.merge(this.defaultShowConfig,N);if(this.showConfig.uploadDirectory!==null&&this.showConfig.uploadDirectory.length===0){this.showConfig.uploadDirectory="/"}if(!this.showConfig.uploadDirectory&&!this.showConfig.updateNodeRef&&!this.showConfig.destination&&!this.showConfig.uploadURL){throw new Error("An updateNodeRef, uploadDirectory, destination or uploadURL must be provided")}this._resetGUI();this._applyConfig();if(this.showConfig.files==null||this.showConfig.files.length==0){B.removeClass(this.id+"-file-selection-controls","hidden");B.addClass(this.id+"-filelist-table","hidden");B.addClass(this.aggregateDataWrapper,"hidden");if(YAHOO.env.ua.ie>9){if(this.fileSelectionInput&&this.fileSelectionInput.parentNode){this.fileSelectionInputParent=this.fileSelectionInput.parentNode;this.fileSelectionInput.parentNode.removeChild(this.fileSelectionInput)}else{this.fileSelectionInputParent=this.widgets.fileSelectionOverlayButton._button.parentNode;this.fileSelectionInputParent.removeChild(this.widgets.fileSelectionOverlayButton._button)}this.fileSelectionInput=document.createElement("input");B.setAttribute(this.fileSelectionInput,"type","file");if(this.suppliedConfig.mode!==this.MODE_SINGLE_UPLOAD&&this.suppliedConfig.mode!==this.MODE_SINGLE_UPDATE){B.setAttribute(this.fileSelectionInput,"multiple","")}B.setAttribute(this.fileSelectionInput,"name","files[]");B.addClass(this.fileSelectionInput,"ie10-dnd-file-selection-button");A.addListener(this.fileSelectionInput,"change",this.onFileSelection,this,true);new v(this.fileSelectionInput,{keys:v.KEY.ENTER},{fn:function M(P){this.fileSelectionInput.click()},scope:this,correctScope:true}).enable();this.fileSelectionInputParent.appendChild(this.fileSelectionInput)}else{if(this.fileSelectionInput&&this.fileSelectionInput.parentNode){this.fileSelectionInput.parentNode.removeChild(this.fileSelectionInput)}this.fileSelectionInput=document.createElement("input");B.setAttribute(this.fileSelectionInput,"type","file");if(this.suppliedConfig.mode!==this.MODE_SINGLE_UPLOAD&&this.suppliedConfig.mode!==this.MODE_SINGLE_UPDATE){B.setAttribute(this.fileSelectionInput,"multiple","")}B.setAttribute(this.fileSelectionInput,"name","files[]");B.addClass(this.fileSelectionInput,"dnd-file-selection-button");A.addListener(this.fileSelectionInput,"change",this.onFileSelection,this,true);this.widgets.fileSelectionOverlayButton._button.parentNode.appendChild(this.fileSelectionInput)}this.widgets.escapeListener.enable();this.widgets.enterListener=new v(this.widgets.fileSelectionOverlayButton._button,{keys:v.KEY.ENTER},{fn:function M(P){this.fileSelectionInput.click()},scope:this,correctScope:true});this.widgets.enterListener.enable();this.panel.setFirstLastFocusable();this.panel.show()}else{B.removeClass(this.id+"-filelist-table","hidden");B.removeClass(this.aggregateDataWrapper,"hidden");B.addClass(this.id+"-file-selection-controls","hidden");this.processFilesForUpload(this.showConfig.files)}},processFilesForUpload:function d(M){var O=0,Q=null,P=null,R;for(var N=0;N<M.length;N++){O+=M[N].size;R=M[N].name;Q=this._getFileValidationErrors(M[N]);if(Q){if(P){P+="<br/>"+Q}else{P=Q}}}this.aggregateUploadTargetSize=O;this._addFiles(0,M.length,this);this._spawnUploads();if(P){Alfresco.util.PopupManager.displayPrompt({title:this.msg("header.error"),text:P,noEscape:true})}},_getFileValidationErrors:function(M){var N=M.name;if(this._maximumFileSizeLimit>0&&M.size>this._maximumFileSizeLimit){return this.msg("message.maxFileFileSizeExceeded",y(N),Alfresco.util.formatFileSize(M.size),Alfresco.util.formatFileSize(this._maximumFileSizeLimit))}else{if(!Alfresco.forms.validation.nodeName({id:"file",value:N},null,null,null,true)){return this.msg("message.illegalCharacters",y(N))}}return null},_addFiles:function t(Z,Y,M){var ab;if(Z<Y){var ac=M.showConfig.files[Z];if(!this._getFileValidationErrors(ac)){var ad="file"+Z;try{var V=function P(aj){Alfresco.logger.debug("File upload progress update received",aj);if(aj.lengthComputable){try{var af=Math.round((aj.loaded*100)/aj.total),ah=M.fileStore[ad];ah.progressPercentage.innerHTML=af+"%";var ai=(-400+((af/100)*400));B.setStyle(ah.progress,"left",ai+"px");M._updateAggregateProgress(ah,aj.loaded);ah.lastProgress=aj.loaded}catch(ag){Alfresco.logger.error("The following error occurred processing an upload progress event: ",ag)}}else{Alfresco.logger.debug("File upload progress not computable",aj)}};var N=function aa(ai){try{Alfresco.logger.debug("File upload completion notification received",ai);var ag=M.fileStore[ad];if(ag.request.readyState!=4){ag.request.onreadystatechange=function ah(){if(ag.request.readyState==4){M._processUploadCompletion(ag)}}}else{M._processUploadCompletion(ag)}}catch(af){Alfresco.logger.error("The following error occurred processing an upload completion event: ",af)}};var O=function T(ah){try{var ag=M.fileStore[ad];if(ag.state!==M.STATE_FAILURE){M._processUploadFailure(ag,ah.status)}}catch(af){Alfresco.logger.error("The following error occurred processing an upload failure event: ",af)}};var ae=ac.name,X=false;if(!!M.showConfig.newVersion&&M.showConfig.updateFilename&&M.showConfig.updateFilename!==ae){X=true}var Q=new XMLHttpRequest();Q.upload._fileData=ad;Q.upload.addEventListener("progress",V,false);Q.upload.addEventListener("load",N,false);Q.upload.addEventListener("error",O,false);data={id:ad,name:ae,size:M.showConfig.files[Z].size};var W=null;if(M.suppliedConfig&&M.suppliedConfig.updateNodeRef){W=M.suppliedConfig.updateNodeRef}var U=ac.relativePath||"";if(M.showConfig.uploadDirectory&&M.showConfig.uploadDirectory!=="/"){U=M.showConfig.uploadDirectory+"/"+U}var R={filedata:M.showConfig.files[Z],filename:ae,destination:M.showConfig.destination,siteId:M.showConfig.siteId,containerId:M.showConfig.containerId,uploaddirectory:U,createdirectory:true,majorVersion:!M.minorVersion.checked,updateNodeRef:W,description:M.description.value,overwrite:M.showConfig.overwrite,thumbnails:M.showConfig.thumbnails,username:M.showConfig.username,updateNameAndMimetype:X};M.fileStore[ad]={state:M.STATE_ADDED,fileName:ae,nodeRef:W,uploadData:R,request:Q};M.dataTable.addRow(data);M.addedFiles[ab]=M._getUniqueFileToken(data);M.widgets.escapeListener.enable();M.panel.setFirstLastFocusable();M.panel.show()}catch(S){Alfresco.logger.error("DNDUpload_show: The following exception occurred processing a file to upload: ",S)}}M._addFiles(Z+1,Y,M)}},_processUploadCompletion:function h(N){if(N.request.status=="200"){var M=Alfresco.util.parseJSON(N.request.responseText);N.nodeRef=M.nodeRef;N.fileName=M.fileName;N.state=this.STATE_SUCCESS;B.addClass(N.progressStatusIncomplete,"hidden");B.removeClass(N.progressStatusComplete,"hidden");B.removeClass(N.progress,"fileupload-progressSuccess-span");B.addClass(N.progress,"fileupload-progressFinished-span");B.setStyle(N.progress,"left",0+"px");N.progressPercentage.innerHTML="100%";this.noOfSuccessfulUploads++;this._updateAggregateProgress(N,N.uploadData.filedata.size);this._updateStatus();this._adjustGuiIfFinished();this._spawnUploads()}else{this._processUploadFailure(N,N.request.status)}},_processUploadFailure:function u(P,M){if(M===401){var S=P.request.getResponseHeader.Location;if(S){window.location.href=window.location.protocol+"//"+window.location.host+S;return}else{window.location.reload(true);return}}P.state=this.STATE_FAILURE;var R=P.request.status+" "+P.request.statusText;try{R=JSON.parse(P.request.responseText).message;R=R.substring(R.indexOf(" ")+1)}catch(O){Alfresco.logger.error("The following error occurred parsing the upload failure message for "+R+": "+O)}var N="label.failure."+M,Q=Alfresco.util.message(N,this.name);if(Q==N){Q=Alfresco.util.message("label.failure",this.name,R)}P.fileSizeInfo.innerHTML=P.fileSizeInfo.innerHTML+" ("+Q+")";P.fileSizeInfo.setAttribute("title",Q);P.progressInfo.setAttribute("title",Q);P.progressInfo.parentElement.setAttribute("title",Q);B.addClass(P.progressStatusIncomplete,"hidden");B.removeClass(P.progressStatusFailed,"hidden");B.removeClass(P.progress,"fileupload-progressSuccess-span");B.addClass(P.progress,"fileupload-progressFailure-span");B.setStyle(P.progress,"left",0+"px");this._updateAggregateProgress(P,P.uploadData.filedata.size);this.noOfFailedUploads++;this._updateStatus();this._adjustGuiIfFinished();this._spawnUploads()},_updateAggregateProgress:function b(O,N){this.aggregateUploadCurrentSize-=O.lastProgress;this.aggregateUploadCurrentSize+=N;var M=(this.aggregateUploadCurrentSize/this.aggregateUploadTargetSize);var P=(-620+(M*620));B.setStyle(this.id+"-aggregate-progress-span","left",P+"px")},_resetGUI:function x(){if(this.statusText==null){this.onReady()}this.state=this.STATE_UPLOADING;this.noOfFailedUploads=0;this.noOfSuccessfulUploads=0;this.statusText.innerHTML="&nbsp;";this.description.value="";this.minorVersion.checked=true;this.widgets.cancelOkButton.set("label",this.msg("button.cancel"));this.widgets.cancelOkButton.set("disabled",false);B.addClass(this.widgets.uploadButton,"hidden");this.widgets.uploadButton.set("label",this.msg("button.upload"));this.widgets.uploadButton.set("disabled",true);this.aggregateUploadTargetSize=0;this.aggregateUploadCurrentSize=0;B.setStyle(this.id+"-aggregate-progress-span","left","-620px");B.removeClass(this.aggregateDataWrapper,"hidden")},onPostRenderEvent:function k(M){if(this.dataTable.getRecordSet().getLength()>0){this.panel.setFirstLastFocusable();this.panel.focusFirst()}},onRowAddEvent:function I(O){try{var P=O.record.getData();var N=this.fileStore[P.id];N.lastProgress=0;this._updateAggregateStatus()}catch(M){Alfresco.logger.error("The following error occurred initiating upload: "+M)}},_spawnUploads:function l(){var Q=this.dataTable.getRecordSet().getLength();for(var P=0;P<Q;P++){var N=this.dataTable.getRecordSet().getRecord(P);var M=N.getData("id");var O=this.fileStore[M];if(O.state==this.STATE_ADDED){this._startUpload(O);return}}},_startUpload:function o(N){N.state=this.STATE_UPLOADING;var M;if(this.showConfig.uploadURL===null){M=Alfresco.constants.PROXY_URI+"api/upload"}else{M=Alfresco.constants.PROXY_URI+this.showConfig.uploadURL}if(Alfresco.util.CSRFPolicy.isFilterEnabled()){M+="?"+Alfresco.util.CSRFPolicy.getParameter()+"="+encodeURIComponent(Alfresco.util.CSRFPolicy.getToken())}if(this.uploadMethod===this.FORMDATA_UPLOAD){Alfresco.logger.debug("Using FormData for file upload");var R=new FormData;R.append("filedata",N.uploadData.filedata);R.append("filename",N.uploadData.filename);R.append("destination",N.uploadData.destination);R.append("uploaddirectory",N.uploadData.uploaddirectory);R.append("createdirectory",N.uploadData.createdirectory?"true":"false");R.append("majorVersion",N.uploadData.majorVersion?"true":"false");R.append("username",N.uploadData.username);R.append("overwrite",N.uploadData.overwrite);R.append("thumbnails",N.uploadData.thumbnails);R.append("updatenameandmimetype",N.uploadData.updateNameAndMimetype);if(N.uploadData.updateNodeRef){R.append("updateNodeRef",N.uploadData.updateNodeRef)}else{R.append("siteId",N.uploadData.siteId);R.append("containerId",N.uploadData.containerId)}if(N.uploadData.description){R.append("description",N.uploadData.description)}N.request.open("POST",M,true);N.request.send(R);N.request.onreadystatechange=function(){if(this.status===401){var S=this.getResponseHeader.Location;if(S){window.location.href=window.location.protocol+"//"+window.location.host+S;return}else{window.location.reload(true);return}}}}else{if(this.uploadMethod===this.INMEMORY_UPLOAD){Alfresco.logger.debug("Using custom multipart upload");var O="----AlfrescoCustomMultipartBoundary"+(new Date).getTime();var Q="\r\n";var P="--"+O;P+=Q+'Content-Disposition: form-data; name="filedata"; filename="'+unescape(encodeURIComponent(N.uploadData.filename))+'"';P+=Q+"Content-Type: image/png";P+=Q+Q+N.uploadData.filedata.getAsBinary()+Q+"--"+O;P+=Q+'Content-Disposition: form-data; name="filename"';P+=Q+Q+unescape(encodeURIComponent(N.uploadData.filename))+Q+"--"+O;P+=Q+'Content-Disposition: form-data; name="destination"';if(N.uploadData.destination!==null){P+=Q+Q+unescape(encodeURIComponent(N.uploadData.destination))+Q+"--"+O}else{P+=Q+Q+Q+"--"+O}P+=Q+'Content-Disposition: form-data; name="siteId"';P+=Q+Q+unescape(encodeURIComponent(N.uploadData.siteId))+Q+"--"+O;P+=Q+'Content-Disposition: form-data; name="containerId"';P+=Q+Q+unescape(encodeURIComponent(N.uploadData.containerId))+Q+"--"+O;P+=Q+'Content-Disposition: form-data; name="uploaddirectory"';P+=Q+Q+unescape(encodeURIComponent(N.uploadData.uploaddirectory))+Q+"--"+O+"--";P+=Q+'Content-Disposition: form-data; name="majorVersion"';P+=Q+Q+unescape(encodeURIComponent(N.uploadData.majorVersion))+Q+"--"+O+"--";if(N.uploadData.updateNodeRef){P+=Q+'Content-Disposition: form-data; name="updateNodeRef"';P+=Q+Q+unescape(encodeURIComponent(N.uploadData.updateNodeRef))+Q+"--"+O+"--"}if(N.uploadData.description){P+=Q+'Content-Disposition: form-data; name="description"';P+=Q+Q+unescape(encodeURIComponent(N.uploadData.description))+Q+"--"+O+"--"}if(N.uploadData.username){P+=Q+'Content-Disposition: form-data; name="username"';P+=Q+Q+unescape(encodeURIComponent(N.uploadData.username))+Q+"--"+O+"--"}if(N.uploadData.overwrite){P+=Q+'Content-Disposition: form-data; name="overwrite"';P+=Q+Q+unescape(encodeURIComponent(N.uploadData.overwrite))+Q+"--"+O+"--"}if(N.uploadData.thumbnails){P+=Q+'Content-Disposition: form-data; name="thumbnails"';P+=Q+Q+unescape(encodeURIComponent(N.uploadData.thumbnails))+Q+"--"+O+"--"}N.request.open("POST",M,true);N.request.setRequestHeader("Content-Type","multipart/form-data; boundary="+O);N.request.sendAsBinary(P)}}},onUploadButtonClick:function m(){this.state=this.STATE_UPLOADING;B.removeClass(this.id+"-filelist-table","hidden");B.removeClass(this.id+"-aggregate-data-wrapper","hidden");B.addClass(this.id+"-file-selection-controls","hidden");B.addClass(this.versionSection,"hidden");this.widgets.uploadButton.set("disabled",true);B.addClass(this.compareVersionsSection,"hidden");this.processFilesForUpload(this.showConfig.files)},onCancelOkButtonClick:function e(){B.addClass(this.compareVersionsSection,"hidden");var O,N;if(this.state===this.STATE_UPLOADING){this._cancelAllUploads();var M=0;for(N in this.fileStore){if(this.fileStore[N]&&this.fileStore[N].state===this.STATE_SUCCESS){M++}}if(M>0){O=YAHOO.lang.substitute(this.msg("message.cancelStatus"),{"0":M})}if(!this.showConfig.suppressRefreshEvent){YAHOO.Bubbling.fire("metadataRefresh",{currentPath:this.showConfig.path})}}else{if(this.state===this.STATE_FINISHED){var Q=null,P;for(N in this.fileStore){P=this.fileStore[N];if(P&&P.state===this.STATE_SUCCESS){Q=P.fileName;break}}if(!this.showConfig.suppressRefreshEvent){if(Q){YAHOO.Bubbling.fire("metadataRefresh",{currentPath:this.showConfig.path,highlightFile:Q})}else{YAHOO.Bubbling.fire("metadataRefresh",{currentPath:this.showConfig.path})}YAHOO.Bubbling.fire("folderCreated",{parentNodeRef:this.showConfig.parentNodeRef})}}}this._clear();this.panel.hide();this.widgets.escapeListener.disable();if(O){Alfresco.util.PopupManager.displayPrompt({text:O})}},_applyConfig:function L(){var R,P;if(this.showConfig.mode===this.MODE_SINGLE_UPLOAD){P=this.msg("header.singleUpload");this.titleText.innerHTML=P}else{if(this.showConfig.mode===this.MODE_MULTI_UPLOAD){P=this.showConfig.files.length==1?"header.multiUpload.singleFile":"header.multiUpload";var O=this.showConfig.uploadDirectoryName==""?this.msg("label.documents"):this.showConfig.uploadDirectoryName;this.titleText.innerHTML=this.msg(P,'<img src="'+Alfresco.constants.URL_RESCONTEXT+'components/documentlibrary/images/folder-open-16.png" class="title-folder" />'+y(O))}else{if(this.showConfig.mode===this.MODE_SINGLE_UPDATE){P=this.msg("header.singleUpdate");this.titleText.innerHTML=P}}}if(this.showConfig.mode===this.MODE_SINGLE_UPDATE){B.removeClass(this.versionSection,"hidden");var N=(this.showConfig.updateVersion||"1.0").split("."),M=parseInt(N[0],10),Q=parseInt(N[1],10);B.get(this.id+"-minorVersion").innerHTML=this.msg("label.minorVersion.more",M+"."+(1+Q));B.get(this.id+"-majorVersion").innerHTML=this.msg("label.majorVersion.more",(1+M)+".0")}else{B.addClass(this.versionSection,"hidden")}if(this.showConfig.mode===this.MODE_MULTI_UPLOAD){B.removeClass(this.statusText,"hidden");this.dataTable.set("height","204px",true)}else{B.addClass(this.statusText,"hidden");this.dataTable.set("height","40px")}},_createEmptyDataTable:function w(){var M=this;var N=function(U,V,W,X){try{M._formatCellElements(U,V,M.fileItemTemplates.left)}catch(T){Alfresco.logger.error("DNDUpload__createEmptyDataTable (formatLeftCell): The following error occurred: ",T)}};var S=function(U,V,W,X){try{M._formatCellElements(U,V,M.fileItemTemplates.center)}catch(T){Alfresco.logger.error("DNDUpload__createEmptyDataTable (formatCenterCell): The following error occurred: ",T)}};var Q=function(U,V,W,X){try{M._formatCellElements(U,V,M.fileItemTemplates.right)}catch(T){Alfresco.logger.error("DNDUpload__createEmptyDataTable (formatRightCell): The following error occurred: ",T)}};this._formatCellElements=function(U,ag,ae){var ab=ag.getData(),W=ab.id;var af=new f(U);var Y=ae.cloneNode(true);Y.setAttribute("id",Y.getAttribute("id")+W);var T=B.getElementsByClassName("fileupload-progressSuccess-span","span",Y);if(T.length==1){this.fileStore[W].progress=T[0]}var ac=B.getElementsByClassName("fileupload-progressInfo-span","span",Y);if(ac.length==1){var V=ab.name;Y.setAttribute("title",V);ac=ac[0];this.fileStore[W].progressInfo=ac;this.fileStore[W].progressInfo.innerHTML=V;this.fileStore[W].progressInfoCell=U}var X=B.getElementsByClassName("fileupload-filesize-span","span",Y);if(X.length==1){var V=Alfresco.util.formatFileSize(ab.size);X=X[0];this.fileStore[W].fileSizeInfo=X;X.innerHTML=V}var ad=B.getElementsByClassName("fileupload-contentType-select","select",Y);if(ad.length==1){this.fileStore[W].contentType=ad[0]}else{ad=B.getElementsByClassName("fileupload-contentType-input","input",Y);if(ad.length==1){this.fileStore[W].contentType=ad[0]}}var aa=B.getElementsByClassName("fileupload-percentage-span","span",Y);if(aa.length==1){this.fileStore[W].progressPercentage=aa[0]}var Z=B.getElementsByClassName("fileupload-status-img","img",Y);if(Z.length==3){this.fileStore[W].progressStatusIncomplete=Z[0];this.fileStore[W].progressStatusComplete=Z[1];this.fileStore[W].progressStatusFailed=Z[2]}af.appendChild(Y)};var R=[{key:"id",className:"col-left",resizable:false,formatter:N},{key:"name",className:"col-center",resizable:false,formatter:S},{key:"created",className:"col-right",resizable:false,formatter:Q}];var P=new YAHOO.util.DataSource([],{responseType:YAHOO.util.DataSource.TYPE_JSARRAY});YAHOO.widget.DataTable._bStylesheetFallback=!!YAHOO.env.ua.ie;var O=B.get(this.id+"-filelist-table");this.dataTable=new YAHOO.widget.DataTable(O,R,P,{scrollable:true,height:"100px",width:"620px",renderLoopSize:1,MSG_EMPTY:this.msg("label.noFiles")});this.dataTable.subscribe("postRenderEvent",this.onPostRenderEvent,this,true);this.dataTable.subscribe("rowAddEvent",this.onRowAddEvent,this,true)},_getUniqueFileToken:function H(M){return M.name+":"+M.size},_updateStatus:function z(){if(this.noOfFailedUploads>0){this.statusText.innerHTML=YAHOO.lang.substitute(this.msg("label.uploadStatus.withFailures"),{"0":this.noOfSuccessfulUploads,"1":this.dataTable.getRecordSet().getLength(),"2":this.noOfFailedUploads})}else{this.statusText.innerHTML=YAHOO.lang.substitute(this.msg("label.uploadStatus"),{"0":this.noOfSuccessfulUploads,"1":this.dataTable.getRecordSet().getLength()})}},_updateAggregateStatus:function D(){this.aggregateProgressText.innerHTML=YAHOO.lang.substitute(this.msg("label.aggregateUploadStatus"),{"0":this.dataTable.getRecordSet().getLength(),"1":Alfresco.util.formatFileSize(this.aggregateUploadTargetSize)})},_adjustGuiIfFinished:function s(){try{var P={successful:[],failed:[]};var O=null;for(var N in this.fileStore){O=this.fileStore[N];if(O){if(O.state==this.STATE_SUCCESS){P.successful.push({fileName:O.fileName,nodeRef:O.nodeRef})}else{if(O.state==this.STATE_FAILURE){P.failed.push({fileName:O.fileName})}else{return}}}}this.state=this.STATE_FINISHED;B.addClass(this.aggregateDataWrapper,"hidden");B.addClass(this.widgets.uploadButton,"hidden");this.widgets.cancelOkButton.set("label",this.msg("button.ok"));this.widgets.cancelOkButton.focus();var Q=this.showConfig.onFileUploadComplete;if(Q&&typeof Q.fn=="function"){Q.fn.call((typeof Q.scope=="object"?Q.scope:this),P,Q.obj)}if(P.failed.length===0){this.onCancelOkButtonClick()}}catch(M){Alfresco.logger.error("_adjustGuiIfFinished",M)}},_cancelAllUploads:function j(){var Q=this.dataTable.getRecordSet().getLength();for(var P=0;P<Q;P++){var N=this.dataTable.getRecordSet().getRecord(P);var M=N.getData("id");var O=this.fileStore[M];if(O.state===this.STATE_UPLOADING){Alfresco.logger.debug("Aborting upload of file: "+O.fileName);O.request.abort()}}},_clear:function E(){var M=this.dataTable.getRecordSet().getLength();this.addedFiles={};this.fileStore={};this.dataTable.deleteRows(0,M)},_isNewFileName:function F(O,M){var P=O.properties["cm:name"];var N=M.name;return(P!=N)},_updateCompareVersionsSection:function q(N,M){this.getMimetypeDescription(M.type,this._extractNewVersionMimetypeDescription,this._setNewVersionDefaultMimetype);B.get(this.id+"-current-version-value").innerHTML=N.properties["cm:versionLabel"];B.get(this.id+"-current-version-filename").innerHTML=N.properties["cm:name"];B.get(this.id+"-current-version-title").innerHTML=N.hasProperty("cm:title")?N.properties["cm:title"]:this.msg("label.none");B.get(this.id+"-current-version-mimetype").innerHTML=N.mimetypeDisplayName;B.get(this.id+"-current-version-last-modified").innerHTML=Alfresco.util.formatDate(this.showConfig.jsNode.properties["cm:modified"].iso8601,"dd/mm/yyyy");B.get(this.id+"-current-version-modified-by").innerHTML=N.properties["cm:modifier"].displayName;B.get(this.id+"-current-version-icon").src=Alfresco.constants.URL_RESCONTEXT+"components/images/filetypes/"+Alfresco.util.getFileIconByMimetype(N.mimetype,48);B.get(this.id+"-new-version-filename").innerHTML=M.name;B.get(this.id+"-new-version-icon").src=Alfresco.constants.URL_RESCONTEXT+"components/images/filetypes/"+Alfresco.util.getFileIconByMimetype(M.type,48)},_setComparisonNewVersionMimetype:function r(M){B.get(this.id+"-new-version-mimetype").innerHTML=M!==""?M:this.msg("label.mimetype.unknown")},_extractNewVersionMimetypeDescription:function c(P,N,M){var Q=N.json.data;var O=String(new Object(M)).toLowerCase();if(Q[O]){P._setComparisonNewVersionMimetype(Q[O].description)}else{P._setComparisonNewVersionMimetype(O)}},_setNewVersionDefaultMimetype:function a(N,M){N._setComparisonNewVersionMimetype(M)},getMimetypeDescription:function p(N,M,O){Alfresco.util.Ajax.jsonGet({url:Alfresco.constants.PROXY_URI+"api/mimetypes/descriptions",successCallback:{fn:function(P){M(this,P,N)},scope:this},failureCallback:{fn:function(){O(this,N)},scope:this}})}})})();